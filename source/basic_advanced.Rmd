---
title: "Basic or advanced statistics"
output: 
  pdf_document: 
    keep_tex: TRUE
  html_notebook: default
---

```{r include = FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  dev = c("pdf", "png"),
  dpi = 300
)
library(tidyverse)
library(ordinal)
library(scales)
```

```{r}
status <- read_csv("../data/status.csv") %>%
  mutate(
    Church = factor(Church),
    Lights = ifelse(Period == "80's", "not", Lights) %>%
      factor(
        levels = c("not", "half", "full"),
        labels = c("dark", "partly lit", "fully lit")
      ),
    Period = factor(
      Period,
      levels = c("80's", "2016")
    ),
    Status = factor(
      Status,
      levels = c("colony", "used", "no bats"),
      ordered = TRUE
    ),
    Colony = as.integer(Status == "colony"),
    ColonyUsed = as.integer(Status != "no bats")
  )
```

```{r}
contrasts <- function(model, contrast, n = 1000){
  cf <- summary(model)$coef
  params <- rnorm(
    n * nrow(cf), 
    mean = cf[, "Estimate"], 
    sd = cf[, "Std. Error"]
  ) %>%
    matrix(nrow = nrow(cf))
  contrast %*% params
}
```

```{r}
current_model <- clm(Status ~ Lights, data = status, subset = Period == "2016")
drop1(current_model, test = "Chisq")
summary(current_model)
```

```{r}
cumulative_logit <- contrasts(
  current_model, 
  contrast =  rbind(
    "colony:dark" = c(1, 0, 0, 0),
    "colony:partly lit" = c(1, 0, -1, 0),
    "colony:fully lit" = c(1, 0, 0, -1),
    "colony or used:dark" = c(0, 1, 0, 0),
    "colony or used:partly lit" = c(0, 1, -1, 0),
    "colony or used:fully lit" = c(0, 1, 0, -1)
  )
)
cumulative_prediction <- cumulative_logit %>%
  plogis() %>%
  apply(
    1, 
    function(x){
      c(
        Mean = mean(x), 
        LCL = quantile(x, 0.025) %>%
          unname(), 
        UCL = quantile(x, 0.975) %>%
          unname()
      )
    }
  ) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Contrast") %>%
  extract(Contrast, c("Status", "Lights"), "(.*):(.*)")
```

```{r base-model, fig.cap = "Estimated cumulative probability"}
ggplot(
  cumulative_prediction, 
  aes(
    x = Lights, 
    y = Mean, ymin = LCL, ymax = UCL, 
    colour = Status
  )
) +
  geom_errorbar(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_y_continuous(
    "Estimated cumulative probability",
    labels = percent, 
    limits = 0:1
  )
```

  
```{r}
status_model <- clmm(Status ~ Period + Lights + (1|Church), data = status)
drop1(status_model, test = "Chisq")
summary(status_model)
```

```{r}
cumulative_logit <- contrasts(
  status_model, 
  contrast =  rbind(
    "colony:80's:dark" = c(1, 0, 0, 0, 0),
    "colony:2016:dark" = c(1, 0, -1, 0, 0),
    "colony:2016:partly lit" = c(1, 0, -1, -1, 0),
    "colony:2016:fully lit" = c(1, 0, -1, 0, -1),
    "colony or used:80's:dark" = c(0, 1, 0, 0, 0),
    "colony or used:2016:dark" = c(0, 1, -1, 0, 0),
    "colony or used:2016:partly lit" = c(0, 1, -1, -1, 0),
    "colony or used:2016:fully lit" = c(0, 1, -1, 0, -1)
  )
)
cumulative_prediction <- cumulative_logit %>%
  plogis() %>%
  apply(
    1, 
    function(x){
      c(
        Mean = mean(x), 
        LCL = quantile(x, 0.025) %>%
          unname(), 
        UCL = quantile(x, 0.975) %>%
          unname()
      )
    }
  ) %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("Contrast") %>%
  extract(Contrast, c("Status", "Period", "Lights"), "(.*):(.*):(.*)")
```

```{r base-model, fig.cap = "Estimated cumulative probability"}
ggplot(
  cumulative_prediction, 
  aes(
    x = Lights, 
    y = Mean, ymin = LCL, ymax = UCL, 
    colour = Status, 
    shape = Period, linetype = Period
  )
) +
  geom_errorbar(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_y_continuous(
    "Estimated cumulative probability",
    labels = percent, 
    limits = 0:1
  ) + 
  coord_flip()
```
